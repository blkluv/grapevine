# Pinata V3 Integration

This document describes the integration of Pinata V3 uploads API for handling feed entry content.

## Overview

The feed entries endpoint now accepts content as base64-encoded data instead of a pre-existing CID. When creating a new feed entry, the content is automatically uploaded to IPFS via Pinata's V3 API, and the resulting CID is stored in the database.

## Configuration

### Environment Variables

Add the following environment variables to your `.env` file:

```bash
# Pinata V3 Uploads Configuration
V3_UPLOADS_URL=https://uploads.pinata.cloud
V3_UPLOADS_ADMIN_KEY=your_pinata_admin_key_here
V3_UPLOADS_USER_ID=your_pinata_user_id_here
```

### Required Credentials

1. **V3_UPLOADS_URL**: The base URL for Pinata's V3 uploads API (defaults to `https://uploads.pinata.cloud`)
2. **V3_UPLOADS_ADMIN_KEY**: Your Pinata admin/bearer token for authentication
3. **V3_UPLOADS_USER_ID**: Your Pinata user ID for x-user-id header

### Database Migration

Before using the new features, run the migration to add the `pinata_upload_id` column:

```bash
# Using psql
psql $DB_URL -f migrations/001_add_pinata_upload_id.sql

# Or manually execute the migration
cat migrations/001_add_pinata_upload_id.sql | psql $DB_URL
```

The migration adds:
- `pinata_upload_id` UUID column to `gv_feed_entries` table (nullable)
- Index on `pinata_upload_id` for efficient lookups
- Column comment for documentation

## API Changes

### Create Feed Entry Endpoint

**Endpoint**: `POST /v1/feeds/{feed_id}/entries`

#### Before (Old Schema)
```json
{
  "cid": "QmXxx...",
  "mime_type": "application/json",
  "title": "Entry Title",
  "piid": "uuid-of-payment-instruction",
  "is_free": false
}
```

#### After (New Schema)
```json
{
  "content_base64": "eyJtZXNzYWdlIjoiSGVsbG8gV29ybGQifQ==",
  "mime_type": "application/json",
  "title": "Entry Title",
  "piid": "uuid-of-payment-instruction",
  "is_free": false
}
```

### Request Changes

- **Removed**: `cid` field (was required)
- **Added**: `content_base64` field (required) - Base64-encoded content that will be uploaded to IPFS

### Response

The response includes the generated `cid` and `pinata_upload_id` along with all other entry fields:

```json
{
  "id": "entry-uuid",
  "feed_id": "feed-uuid",
  "cid": "QmXxx...",  // Generated by Pinata after upload
  "mime_type": "application/json",
  "pinata_upload_id": "pinata-file-uuid",  // Pinata's internal file ID
  "title": "Entry Title",
  "metadata": null,
  "tags": null,
  "is_free": false,
  "expires_at": null,
  "piid": "payment-instruction-uuid",
  "created_at": 1234567890,
  "updated_at": 1234567890
}
```

## Implementation Details

### Upload Service (`src/services/pinataV3.ts`)

The `uploadToPinata` function handles:
- Base64 to Buffer conversion
- Form data creation with proper MIME types
- Authentication headers (admin-key + x-pinata-user-id)
- **Automatic Group Creation**: If `V3_UPLOADS_GROUP_NAME` is configured, automatically creates or retrieves the group ID before uploading
- Error handling for upload failures
- Metadata attachment (feed_id, timestamp)
- **CID Validation**: Validates the returned CID to ensure it's a valid IPFS CID (CIDv0 or CIDv1)

#### Group Management

Groups are used to organize related uploads in the Pinata dashboard. The system uses a smart grouping strategy:

**Feed-Based Grouping:**
- When creating a feed, the system calls `createGroup()` to create a Pinata group using the feed name
- Uses Pinata's PUT `/v3/groups` endpoint which creates the group if it doesn't exist or returns the existing one
- The returned group ID is used as the feed ID in the database
- Each feed is its own Pinata group, making it easy to organize and manage all entries within that feed

Groups help organize and manage files within the Pinata dashboard, making it easier to track and manage content by feed.

### Upload Options

The service automatically sets:
- `name`: Uses the entry title or generates one based on feed name and timestamp
- `network`: Set to `"public"` for public accessibility
- `keyvalues`: Includes `feed_id` and `timestamp` for tracking

### Error Handling

If the upload to Pinata fails:
- The entry is NOT created in the database
- A 500 error is returned with details: `"Failed to upload content to IPFS: {error message}"`
- The original error is logged on the server

## Testing

### Test Helpers

New test helpers are available in `test/helpers/pinata.ts`:

```typescript
import { generateTestContent, stringToBase64, objectToBase64 } from './helpers/pinata';

// Generate test JSON content
const contentBase64 = generateTestContent('json');

// Convert string to base64
const textContent = stringToBase64('Hello World');

// Convert object to base64 JSON
const jsonContent = objectToBase64({ message: 'Hello' });
```

### Mock Configuration

For testing, set mock environment variables in `.env.test`:

```bash
V3_UPLOADS_URL=https://uploads.pinata.cloud
V3_UPLOADS_ADMIN_KEY=test_admin_key
V3_UPLOADS_USER_ID=test_user_id
```

## Migration Notes

### Existing Entries

- Existing entries with pre-set CIDs remain unchanged
- The database schema for `gv_feed_entries` table stays the same
- Only new entry creation is affected

### Client Updates Required

Clients calling the create entry endpoint must:
1. Encode their content as base64 before sending
2. Change the field name from `cid` to `content_base64`
3. Handle new upload-related error messages

## Example Usage

### JavaScript/TypeScript Client

```typescript
// Prepare content
const content = {
  message: "Hello, Grapevine!",
  timestamp: Date.now()
};

// Convert to base64
const contentBase64 = Buffer.from(JSON.stringify(content)).toString('base64');

// Create entry
const response = await fetch(`/v1/feeds/${feedId}/entries`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'x-wallet-address': walletAddress,
    'x-signature': signature,
    'x-message': message,
    'x-timestamp': timestamp
  },
  body: JSON.stringify({
    content_base64: contentBase64,
    mime_type: 'application/json',
    title: 'My Entry',
    piid: paymentInstructionId,
    is_free: false
  })
});

const entry = await response.json();
console.log('Entry created with CID:', entry.cid);
```

### cURL Example

```bash
# Encode content
CONTENT=$(echo '{"message":"Hello World"}' | base64)

# Create entry
curl -X POST "http://localhost:3000/v1/feeds/{feed-id}/entries" \
  -H "Content-Type: application/json" \
  -H "x-wallet-address: 0x..." \
  -H "x-signature: 0x..." \
  -H "x-message: ..." \
  -H "x-timestamp: $(date +%s)" \
  -d "{
    \"content_base64\": \"$CONTENT\",
    \"mime_type\": \"application/json\",
    \"title\": \"Test Entry\",
    \"piid\": \"payment-instruction-uuid\",
    \"is_free\": false
  }"
```

## Troubleshooting

### Missing Environment Variables

**Error**: `Missing required Pinata V3 environment variables`

**Solution**: Ensure all three environment variables are set:
- `V3_UPLOADS_URL`
- `V3_UPLOADS_ADMIN_KEY`
- `V3_UPLOADS_USER_ID`

### Upload Failures

**Error**: `Failed to upload content to IPFS: {details}`

**Common causes**:
1. Invalid Pinata credentials
2. Network connectivity issues
3. Pinata service downtime
4. File size exceeds limits (100MB for form data uploads)
5. Invalid base64 encoding

**Solution**: Check server logs for detailed error messages and verify credentials.

### Invalid CID Received

**Error**: `Invalid CID received from Pinata: {cid}`

**Cause**: The Pinata API returned a response but the CID format is invalid or missing.

**Solution**:
1. Check Pinata service status
2. Verify API credentials and permissions
3. Contact Pinata support if the issue persists

### Base64 Encoding Issues

**Error**: `Invalid base64 string`

**Solution**: Ensure content is properly encoded:
- Use standard base64 encoding (not base64url)
- No line breaks or whitespace in the base64 string
- Test with: `Buffer.from(contentBase64, 'base64')` in Node.js

## Security Considerations

1. **Content Size**: Consider adding validation for maximum content size
2. **Rate Limiting**: Implement rate limiting on the entry creation endpoint
3. **Content Validation**: Validate MIME types and content structure before upload
4. **API Keys**: Never expose Pinata credentials in client-side code
5. **Upload Permissions**: Only feed owners can upload entries (enforced by wallet auth)

## Future Enhancements

Potential improvements:
- Support for direct file uploads (multipart/form-data)
- Chunked uploads for large files using TUS protocol
- Content deduplication before upload
- Upload progress tracking
- Batch upload support for multiple entries
- Custom IPFS gateways configuration
